---
layout: post
title: "Testing with Mocha"
author: NodeKC
tags:
---

# Testing with Mocha

As proper software craftspeople we should be writing tests to ensure the correctness of our software. That\'s especially true when it comes to a dynamic language like JavaScript. There are several good testing frameworks for JavaScript, but in this lab you will be introduced to [Mocha](https://github.com/visionmedia/mocha) by running through the [Bowling Kata](http://butunclebob.com/ArticleS.UncleBob.TheBowlingGameKata).

* [Intro to Mocha](#intro_to_mocha)
* [Assertions](#assertions)
* [Setup](#setup)
* [The bowling kata](#the_bowling_kata)

## Intro to Mocha

Mocha is a very versatile testing framework with many ways to use it, but we\'ll focus on the BDD (see [Behavior driven development](http://en.wikipedia.org/wiki/Behavior-driven_development)) style interface. Groups of tests are defined by the `describe()` function while individual behaviors are defined by the `it()` method. For example:

{% highlight javascript %}
describe('my module', function() {
  before(function() {
    // Some setup
  });

  it('should do amazing things', function() {
     // Put some assertions in here
  });

  after(function() {
    // Some tear-down
  });
});
{% endhighlight %}

If you need to do some setup or tear-down before all behaviors, you can use the `before` or `after` functions respectively. Likewise, `beforeEach` and `afterEach` will perform setup or tear-down for each behavior.

## Assertions

There are some great third party assertion libraries like [Should](https://github.com/visionmedia/should.js/). However, the built in [assert](http://nodejs.org/api/assert.html) module gets the job done as well and that\'s what we\'ll use throughout this lab.

## Setup

Create a new empty directory called `test-lab`. Inside the `test-lab` directory run `npm init`. Next, run `npm install --save-dev mocha` to install mocha as a development dependency. Finally, open the `package.json` file and update the command under `scripts.test` to `node_modules/mocha/bin/mocha tests --recursive`. Once all of that\'s done, your `package.json` should look like this:

**Note:** If you\'re on Windows, be sure to change the path separators in the `test` command to two backslashes: `node_modules\\mocha\\bin\\mocha tests --recursive`

{% highlight javascript %}
{
  "name": "test-lab",
  "version": "0.0.0",
  "main": "index.js",
  "scripts": {
    "test": "node_modules/mocha/bin/mocha tests --recursive"
  },
  "repository": "",
  "author": "",
  "license": "BSD",
  "devDependencies": {
    "mocha": "~1.9.0"
  }
}
{% endhighlight %}

Now, create a folder called `test` and a file inside that called `bowling-spec.js`. If you run `npm test` at this point npm will invoke our test script, running mocha, and showing this result:

{% highlight bash %}
> npm test

> bowling@0.0.0 test /Users/joe/Code/bowling
> node_modules/mocha/bin/mocha tests --recursive

0 passing (1ms)
{% endhighlight%}

## The Bowling Kata

In the Bowling Kata we\'ll use mocha specs to drive the creation of a module that represents a game of bowling. The module should export a function called `score()` that calculates the current score of the game based on the pins knocked down in each frame. As a quick reminder a bowling game can have up to 21 rolls depending on how you roll in the 10th frame. Check this out if you need a refresher on the rules for [scoring a bowling game](http://slocums.homestead.com/gamescore.html).

Make a directory called `source` and a file inside of that called `bowling.js`. You can start with this for `source/bowling.js`:

{% highlight javascript %}
var BowlingGame = function () {
   this.rolls = [];
};

BowlingGame.prototype.roll = function (pins) {
   // record this roll
};

BowlingGame.prototype.score = function () {
   return 0;
};

module.exports = BowlingGame;
{% endhighlight %}

And to start you off with a few tests `test/bowling-spec.js` will look like this:

{% highlight javascript %}
var assert = require('assert');
var BowlingGame = require('../source/bowling');

describe('Bowling scorer', function () {

   beforeEach(function () {
      this.game = new BowlingGame();
   });

   // This test should be passing
   it('should return a score of 0 if no pins have been knocked down', function () {
      var score = this.game.score();
      assert.equal(score, 0);
   });

   // This test should be failing at this point
   it('should return a score of 1 if 1 pin has been knocked down', function () {
      this.game.roll(1);
      var score = this.game.score();
      assert.equal(score, 1);
   });

});
{% endhighlight %}

The result of running NPM test should now look like this:

{% highlight bash %}
> npm test

> bowling@0.0.0 test /Users/joe/Code/bowling
> node_modules/mocha/bin/mocha tests --recursive
  ․․

  1 passing (4ms)
  1 failing

  1) Bowling scorer should return a score of 1 if 1 pin has been knocked down:
     AssertionError: 0 == 1
      at Context.<anonymous> (/Users/joe/Code/bowling/tests/bowling-spec.js:18:14)
      at Test.Runnable.run (/Users/joe/Code/bowling/node_modules/mocha/lib/runnable.js:221:32)
      at Runner.runTest (/Users/joe/Code/bowling/node_modules/mocha/lib/runner.js:374:10)
      at /Users/joe/Code/bowling/node_modules/mocha/lib/runner.js:452:12
      at next (/Users/joe/Code/bowling/node_modules/mocha/lib/runner.js:299:14)
      at /Users/joe/Code/bowling/node_modules/mocha/lib/runner.js:309:7
      at next (/Users/joe/Code/bowling/node_modules/mocha/lib/runner.js:247:23)
      at /Users/joe/Code/bowling/node_modules/mocha/lib/runner.js:271:7
      at Hook.Runnable.run (/Users/joe/Code/bowling/node_modules/mocha/lib/runnable.js:223:5)
      at next (/Users/joe/Code/bowling/node_modules/mocha/lib/runner.js:259:10)
      at Object._onImmediate (/Users/joe/Code/bowling/node_modules/mocha/lib/runner.js:276:5)
      at processImmediate [as _immediateCallback] (timers.js:330:15)

npm ERR! weird error 1
npm ERR! not ok code 0
{% endhighlight %}

Now, write the rest of the behaviors and implement the remainder of the scorer for yourself.